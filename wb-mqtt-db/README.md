wb-mqtt-db
==========

Сервис для сохранения данных в БД sqlite.

Соглашения о наименованиях в MQTT: https://github.com/contactless/homeui/blob/contactless/conventions.md

Протокол для получения данных из БД: https://github.com/contactless/mqtt-rpc


Конфигурация демона сохранения
------------------------------

В примере демон сохраняет данные от устройств “kvadro-1wire_69" и "wb-w1" (драйвера встроенных портов 1-wire). 
Данные от устройства “kvadro-1wire_42” из конфига выше не сохраняются.

```
root@wirenboard:~# cat /etc/wb-mqtt-db.conf
```

```
{
	"groups": [
    	{
            "name": "w1",
        	"channels" : ["kvadro-1wire_69/+", "wb-w1/+"],
        	"values" : 10000,
        	"values_total" : 100000,
        	"min_interval" : 5000,
        	"min_unchanged_interval" : 360000
    	}
	],
	"database" : "/var/lib/wirenboard/db/data.db",
    "debug": false
}
```



5000 - сохранять не чаще, чем раз в пять секунд, 360000 - сохранять опорные значения раз в час.


Логи и подробный вывод
----------------------

Сервис использует библиотеку Google gLog для обработки логов и отладочной информации.

Подробный вывод программы можно получить, используя флаги -v (-v -v или -v -v -v). Вывод при этом будет направлен 
как в файлы логов, так и в stderr.

```
root@wirenboard:~# wb-mqtt-db -v -v -v -c /path/to/config.conf
```

По умолчанию логи сохраняются в /var/log/wirenboard. Установить другую директорию можно с помощью переменной окружения
GLOG\_log\_dir. (При запуске демона переменная определяется в файле /etc/default/wb-mqtt-db).

```
root@wirenboard:~# GLOG_log_dir=/my/log/dir/ wb-mqtt-db -c /path/to/config.conf
```

В директории с логами создаются файлы вида wb-mqtt-db.<hostname>.<user>.log.<level>.<timestamp>. Самые полные логи (содержащие
все записываемые сообщения) имеют вместо <level> значение INFO. Также на самый актуальный лог-файл создаётся ссылка с именем
wb-mqtt-db.INFO. 

Для копирования самого последнего лог-файла можно использовать команду: (ключ -L - разыменование ссылки)

```
root@wirenboard:~# cp -L /var/log/wirenboard/wb-mqtt-db.INFO recent.log
```


Дополнительные настройки логгирования
-------------------------------------

Можно настроить также вывод дополнительной отладочной информации (verbose mode). Делается это аналогичным способом:

```
root@wirenboard:~# GLOG_logtostderr=1 GLOG_v=n wb-mqtt-db -c /path/to/config.conf
````

Здесь n >= 0:

* n = 0: информация о событиях вызова процедур RPC;
* n = 1: + информация о записях в БД;
* n = 2: + информация о принимаемых сообщениях MQTT.

Если не включить GLOG_logtostderr в последнем примере, подробная информация будет выводиться в лог-файл.
Это можно использовать, например, при отладке в режиме демона и следить за файлом командой

```
# tail -f /path/to/logfile
```

Более подрбную информацию о работе с логгированием (вывод информации только конкретных модулей и т.д.)
см. в документации gLog.
